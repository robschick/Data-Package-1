---
title: "Zc84 - Dygraph"
author: "Rob Schick"
date: "`r Sys.Date()`"
output:
  html_document:
    fig_width: 7
    fig_height: 6
    fig_caption: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
# knitr::opts_chunk$set(fig.keep = 'high')
# knitr::opts_chunk$set(fig.path = '../results/')
# knitr::opts_chunk$set(dev = c('png', 'pdf'), 
#         fig.align = 'center', fig.height = 5, fig.width = 8.5, 
#         pdf.options(encoding = "ISOLatin9.enc")) 
library(xts)
library(timetk)
library(here)
library(lubridate)
library(tidyverse)
library(dygraphs)
library(suncalc)
```

## Libraries Used
Here's the list of libraries I'm using:

```{r eval=FALSE}
library(xts)
library(timetk)
library(here)
library(lubridate)
library(tidyverse)
library(dygraphs)
library(suncalc)
```


## Zc084 Dive Plotting 
Goal of this is to produce an interactive time series that may facilitate exploration of the time series, and perhaps allow for some enhanced annotation. 

Here's the data I'm reading in. Note that we could do this with each of the series data and/or the data frame/data package that we make.

```{r read_data}
mycols <- cols(
  DeployID = col_character(),
  Ptt = col_double(),
  DepthSensor = col_double(),
  Source = col_character(),
  Instr = col_character(),
  Day = col_date(format = "%d-%b-%Y"),
  Time = col_time(format = "%H:%M:%S"),
  LocationQuality = col_logical(),
  Latitude = col_logical(),
  Longitude = col_logical(),
  Depth = col_double(),
  DRange = col_double(),
  Temperature = col_logical(),
  TRange = col_logical(),
  Activity = col_logical(),
  ARange = col_logical(),
  Date = col_double(),
  original = col_character()
)

zc84 <- read_csv(here::here('data', 'data-raw', 'ZcTag084_DUML_series_20200108.csv'), col_types = mycols) 
zc84$timestamp = as.POSIXct(paste(zc84$Day, zc84$Time), format = "%Y-%m-%d %H:%M:%S", tz = "UTC")
```


With the raw data read in, we need to convert it to an `xts Time-Series` object

```{r}
zc84_tbl <- tibble::tibble(
    date = zc84$timestamp,
    depth = -1 * zc84$Depth,
    lower = -1 * (zc84$Depth - zc84$DRange),
    upper = -1 * (zc84$Depth + zc84$DRange))  
 
zc84_xts <- tk_xts(zc84_tbl, tzone = "UTC")
```


Here's the entire dive record (we'll pare it down later):

```{r}
dygraph(zc84_xts) %>% 
  dySeries(c("lower", "depth", "upper"), label = "Depths") %>%
  dyOptions(colors = RColorBrewer::brewer.pal(3, "Set2")) %>% 
  dyOptions(useDataTimezone = TRUE) %>% 
  dyLegend(show = "follow") 
```

# Sunrise - Sunset
Let's plot the day/night periods

```{r}
cape.hatteras = c(lat = 35.254581, lon = -75.51995)

date_range = c(floor_date(zc84$Day[1], 'day'),
               ceiling_date(zc84$Day[nrow(zc84)], 'day'))

# compute date axis breaks
dateseq = seq(from = date_range[1], to = date_range[2], by = 'day')

almanac = getSunlightTimes(as.Date(dateseq), 
                                   lat = cape.hatteras['lat'], 
                                   lon = cape.hatteras['lon'], keep = c("sunrise", "sunset"))

# munged sunrise/sunset times for plotting and shading
night_periods = data.frame(from = almanac$sunset[1:(nrow(almanac)-1)], 
                           to = almanac$sunrise[-1])

```

Now we have the data created, let's incorporate it and plot it with dygraph:

```{r, echo=TRUE}
#function to creating shading in a list
add_shades <- function(x, periods, ...) {
  for( period in periods ) {
    x <- dyShading(x, from = period$from , to = period$to, ... )
  }
  x
}

day_night <- apply(night_periods, 1, as.list)

dygraph(zc84_xts) %>% 
  dySeries(c("lower", "depth", "upper"), label = "Depths") %>%
  dyOptions(colors = RColorBrewer::brewer.pal(3, "Set2")) %>% 
  dyOptions(useDataTimezone = FALSE) %>%
dyRangeSelector(dateWindow = c("2019-05-24", "2019-05-25")) %>%
  add_shades(day_night, color = gray(0.90) ) %>%
  dyLegend(show = "follow") 
  
```
